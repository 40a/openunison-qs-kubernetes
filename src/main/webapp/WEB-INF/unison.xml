<?xml version="1.0" encoding="UTF-8"?>
<tremoloConfig xmlns="http://www.tremolosecurity.com/tremoloConfig" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.tremolosecurity.com/tremoloConfig tremoloConfig.xsd" ldapRoot="o=Tremolo" groupObjectClass="groupOfUniqueNames" groupMemberAttribute="uniqueMember" userObjectClass="inetOrgPerson">
  <applications openSessionCookieName="openSession" openSessionTimeout="9000">
    <application name="k8s" azTimeoutMillis="30000" >
      <urls>
        <url regex="false" authChain="oidc" overrideHost="true" overrideReferer="true">
          <host>#[OU_HOST]</host>
          <filterChain>
          </filterChain>
          <uri>/api</uri>
          <proxyTo>#[K8S_DASHBOARD_URL]${fullURI}</proxyTo>
          <results>
            <azSuccess>oauth2bearer</azSuccess>
          </results>
          <azRules>
            <rule scope="dn" constraint="o=Tremolo" />
          </azRules>
        </url>
        <url regex="false" authChain="oidc" overrideHost="true" overrideReferer="true">
          <host>#[OU_HOST]</host>
          <filterChain>
          </filterChain>
          <uri>/ui</uri>
          <proxyTo>#[K8S_DASHBOARD_URL]${fullURI}</proxyTo>
          <results>
            <azSuccess>oauth2bearer</azSuccess>
          </results>
          <azRules>
            <rule scope="dn" constraint="o=Tremolo" />
          </azRules>
        </url>
        <url regex="false" authChain="oidc" overrideHost="true" overrideReferer="true">
          <host>#[OU_HOST]</host>
          <filterChain>
          </filterChain>
          <uri>/</uri>
          <results>
          </results>
          <azRules>
            <rule scope="dn" constraint="o=Tremolo" />
          </azRules>
        </url>
        <url regex="false" authChain="oidc" overrideHost="true" overrideReferer="true">
          <host>#[OU_HOST]</host>
          <filterChain>
            <filter class="com.tremolosecurity.proxy.filters.RemovePrefix">
              <param name="prefix" value="/scale-token"/>
              <param name="attributeName" value="trimmedURI"/>
            </filter>
          </filterChain>
          <uri>/scale-token</uri>
          <proxyTo>https://cdn.rawgit.com/TremoloSecurity/OpenUnison/1.0.8/unison/unison-scalejs-token/src/main/html${trimmedURI}</proxyTo>
          <results>
            <azSuccess>
            </azSuccess>
          </results>
          <azRules>
            <rule scope="dn" constraint="o=Tremolo" />
          </azRules>
        </url>
        <url regex="false" authChain="oidc" overrideHost="true" overrideReferer="true">
          <host>#[OU_HOST]</host>
          <filterChain>
            <filter class="com.tremolosecurity.proxy.filters.RemovePrefix">
              <param name="prefix" value="/scale-token"/>
              <param name="attributeName" value="trimmedURI"/>
            </filter>
          </filterChain>
          <uri>/scale</uri>
          <proxyTo>https://cdn.rawgit.com/TremoloSecurity/OpenUnison/1.0.8/unison/unison-scalejs-main/src/main/html${trimmedURI}</proxyTo>
          <results>
            <azSuccess>
            </azSuccess>
          </results>
          <azRules>
            <rule scope="dn" constraint="o=Tremolo" />
          </azRules>
        </url>
        <url regex="false" authChain="oidc" overrideHost="true" overrideReferer="true">
          <host>#[OU_HOST]</host>
          <filterChain>
            <filter class="com.tremolosecurity.scalejs.token.ws.ScaleToken">
              <param name="displayNameAttribute" value="mail"/>
              <param name="frontPage.title" value="Tokens for Kubernetes Kubectl"/>
              <param name="frontPage.text" value="Use this token for working with Kubernetes web services"/>
              <param name="logoutURL" value="/logout"/>
              <param name="homeURL" value="/"/>
              <param name="warnMinutesLeft" value="5" />
              <param name="tokenClassName" value="com.tremolosecurity.scalejs.IdTokenLoader"/>
              <param name="showTokenURL" value="false"/>
              <param name="idTokenURL" value=""/>
              <param name="showClientSecret" value="true"/>
              <param name="usage" value="Add the id_token and client_secret to your kubectl"/>
            </filter>
          </filterChain>
          <uri>/scale-token/token</uri>
          <results>
            <azSuccess>
            </azSuccess>
          </results>
          <azRules>
            <rule scope="dn" constraint="o=Tremolo" />
          </azRules>
        </url>
        <url regex="false" authChain="oidc" overrideHost="true" overrideReferer="true">
          <host>#[OU_HOST]</host>
          <filterChain>
            <filter class="com.tremolosecurity.scalejs.ws.ScaleMain">
              <param name="displayNameAttribute" value="mail"/>
              <param name="frontPage.title" value="Kubernetes Access Portal"/>
              <param name="frontPage.text" value="Use this portal to access resources and namespaces in Kubernetes"/>
              <param name="canEditUser" value="false"/>
              <param name="workflowName" value=""/>
              <parma name="warnMinutesLeft" value="5" />
              <param name="attributeNames" value="uid"/>
              <param name="uid.displayName" value="Login ID"/>
              <param name="uid.readOnly" value="true"/>
              <param name="attributeNames" value="mail"/>
              <param name="uid.displayName" value="Email Address"/>
              <param name="uid.readOnly" value="true"/>
              <param name="uidAttributeName" value="uid"/>
              <param name="roleAttribute" value=""/>
              <param name="approvalAttributeNames" value="uid"/>
              <param name="approvalAttributeNames" value="mail"/>
              <param name="approvals.uid" value="Login ID"/>
              <param name="approvals.mail" value="Email Address"/>
              <param name="showPortalOrgs" value="false"/>
              <param name="logoutURL" value="/logout"/>
            </filter>
          </filterChain>
          <uri>/scale/main</uri>
          <results>
            <azSuccess>
            </azSuccess>
          </results>
          <azRules>
            <rule scope="dn" constraint="o=Tremolo" />
          </azRules>
        </url>
        <url regex="false" authChain="formloginFilter" overrideHost="true" overrideReferer="true">
          <host>#[OU_HOST]</host>
          <filterChain>
            <filter class="com.tremolosecurity.prelude.filters.StopProcessing" />
          </filterChain>
          <uri>/logout</uri>
          <proxyTo>http://dnm${fullURI}</proxyTo>
          <results>
            <azSuccess>Logout</azSuccess>
          </results>
          <azRules>
            <rule scope="dn" constraint="o=Tremolo" />
          </azRules>
        </url>
      </urls>
      <cookieConfig>
        <sessionCookieName>tremolosession</sessionCookieName>
        <domain>#[OU_HOST]</domain>
        <logoutURI>/logout</logoutURI>
        <keyAlias>session-unison</keyAlias>
        <secure>true</secure>
        <timeout>900</timeout>
        <scope>-1</scope>
      </cookieConfig>
    </application>
    <application name="CheckSession" azTimeoutMillis="30000" >
      <urls>
        <url regex="false" authChain="anon" overrideHost="true" overrideReferer="true">
          <host>#[OU_HOST]</host>
          <filterChain>
            <filter class="com.tremolosecurity.proxy.filters.CheckSession">
              <param name="applicationName" value="k8s"/>
            </filter>
          </filterChain>
          <uri>/scale-token/sessioncheck</uri>
          <results>
            <azSuccess>
            </azSuccess>
          </results>
          <azRules>
            <rule scope="dn" constraint="o=Tremolo" />
          </azRules>
        </url>
        <url regex="false" authChain="anon" overrideHost="true" overrideReferer="true">
          <host>#[OU_HOST]</host>
          <filterChain>
            <filter class="com.tremolosecurity.proxy.filters.CheckSession">
              <param name="applicationName" value="k8s"/>
            </filter>
          </filterChain>
          <uri>/scale/sessioncheck</uri>
          <results>
            <azSuccess>
            </azSuccess>
          </results>
          <azRules>
            <rule scope="dn" constraint="o=Tremolo" />
          </azRules>
        </url>
      </urls>
      <cookieConfig>
        <sessionCookieName>checksession</sessionCookieName>
        <domain>#[OU_HOST]</domain>
        <logoutURI>/scale-token/sessioncheck</logoutURI>
        <keyAlias>session-unison</keyAlias>
        <secure>false</secure>
        <timeout>true</timeout>
        <scope>-1</scope>
      </cookieConfig>
    </application>
    <application name="OidcIdP" isApp="false">
      <urls>
        <url regex="false">
          <host>#[OU_HOST]</host>
          <filterChain>
          </filterChain>
          <uri>/auth/idp/oidc</uri>
          <results>
            <auSuccess>
            </auSuccess>
            <auFail>Default Login Failure</auFail>
            <azSuccess>
            </azSuccess>
            <azFail>Default Login Failure</azFail>
          </results>
          <azRules>
            <rule scope="filter" constraint="(objectClass=*)"/>
          </azRules>
          <idp className="com.tremolosecurity.idp.providers.OpenIDConnectIdP">
            <params name="jwtSigningKey" value="unison-tls"/>
            <params name="driver" value="#[OU_JDBC_DRIVER]"/>
            <params name="url" value="#[OU_JDBC_URL]"/>
            <params name="user" value="#[OU_JDBC_USER]"/>
            <params name="password" value="#[OU_JDBC_PASSWORD]"/>
            <params name="maxCons" value="5"/>
            <params name="maxIdleCons" value="5"/>
            <params name="dialect" value="#[OU_HIBERNATE_DIALECT]"/>
            <params name="validationQuery" value="#[OU_JDBC_VALIDATION]"/>
            <mappings strict="true">
              <mapping targetAttributeName="sub" targetAttributeSource="uid" sourceType="user"/>
            </mappings>
            <trusts>
              <trust name="#[K8S_URL]">
                <param name="clientID" value="kubernetes"/>
                <param name="clientSecret" value="#[K8S_CLIENT_SECRET]"/>
                <param name="redirectURI" value="#[K8S_URL]/redirect_uri"/>
                <param name="codeLastMileKeyName" value="lastmile-k8s"/>
                <param name="authChainName" value="formloginFilter"/>
                <param name="codeTokenSkewMilis" value="60000"/>
                <param name="accessTokenTimeToLive" value="60000"/>
                <param name="accessTokenSkewMillis" value="120000" />
              </trust>
            </trusts>
          </idp>
        </url>
      </urls>
      <cookieConfig>
        <sessionCookieName>tremolosession</sessionCookieName>
        <domain>#[OU_HOST]</domain>
        <logoutURI>/logout</logoutURI>
        <keyAlias>session-unison</keyAlias>
        <secure>true</secure>
        <timeout>900</timeout>
        <scope>-1</scope>
      </cookieConfig>
    </application>
  </applications>
  <myvdConfig>WEB-INF/myvd.conf</myvdConfig>
  <authMechs>
    <mechanism name="anonymous">
      <uri>/auth/anon</uri>
      <className>com.tremolosecurity.proxy.auth.AnonAuth</className>
      <init>
        <param name="userName" value="uid=Anonymous"/>
        <param name="role" value="Users" />
      </init>
      <params>
      </params>
    </mechanism>
    <mechanism name="oidc">
      <uri>/auth/oidc</uri>
      <className>com.tremolosecurity.unison.proxy.auth.openidconnect.OpenIDConnectAuthMech</className>
      <init />
      <params />
    </mechanism>
    <mechanism name="loginForm">
      <uri>/auth/formLogin</uri>
      <className>com.tremolosecurity.proxy.auth.FormLoginAuthMech</className>
      <init>
      </init>
      <params>
        <param>FORMLOGIN_JSP</param>
      </params>
    </mechanism>
    <mechanism name="genoidctoken">
      <uri>/auth/oidctoken</uri>
      <className>com.tremolosecurity.proxy.auth.GenerateOIDCTokens</className>
      <init>
      </init>
      <params />
    </mechanism>
    <mechanism name="jit">
      <uri>/auth/jit</uri>
      <className>com.tremolosecurity.provisioning.auth.JITAuthMech</className>
      <init>
      </init>
      <params>
      </params>
    </mechanism>
    <mechanism name="map">
      <uri>/auth/map</uri>
      <className>com.tremolosecurity.proxy.auth.MappingAuthmech</className>
      <init>
      </init>
    </mechanism>
  </authMechs>
  <authChains>
    <chain name="anon" level="0">
      <authMech>
        <name>anonymous</name>
        <required>required</required>
        <params>
        </params>
      </authMech>
    </chain>
    <chain name="oidc" level="20" root="o=Tremolo">
      <authMech>
        <name>oidc</name>
        <required>required</required>
        <params>
          <param name="bearerTokenName" value="kcBearerToken" />
          <param name="clientid" value="#[OIDC_CLIENT_ID]" />
          <param name="secretid" value="#[OIDC_CLIENT_SECRET]" />
          <param name="responseType" value="code" />
          <param name="idpURL" value="#[OIDC_IDP_URL]" />
          <param name="scope" value="#[OIDC_SCOPE]" />
          <param name="linkToDirectory" value="false" />
          <param name="noMatchOU" value="oidc" />
          <param name="lookupFilter" value="(uid=x)" />
          <param name="uidAttr" value="sub" />
          <param name="userLookupClassName" value="com.tremolosecurity.unison.proxy.auth.openidconnect.loadUser.LoadJWTFromAccessToken" />
          <param name="hd" value="" />
          <param name="loadTokenURL" value="#[OIDC_LOAD_TOKEN_URL]" />
          <param name="jwtTokenAttributeName" value="id_token" />
          <param name="defaultObjectClass" value="inetOrgPerson" />
        </params>
      </authMech>
      <authMech>
        <name>map</name>
        <required>required</required>
        <params>
          <param name="map" value="uid=sub" />
          <param name="map" value="mail=email" />
        </params>
      </authMech>
      <authMech>
        <name>jit</name>
        <required>required</required>
        <params>
          <param name="nameAttr" value="uid" />
          <param name="workflowName" value="jitdb" />
        </params>
      </authMech>
      <authMech>
        <name>genoidctoken</name>
        <required>required</required>
        <params>
          <param name="idpName" value="OidcIdP" />
          <param name="trustName" value="kubernetes" />
        </params>
      </authMech>
    </chain>
    <chain name="formloginFilter" level="20">
      <authMech>
        <name>loginForm</name>
        <required>required</required>
        <params>
          <param name="FORMLOGIN_JSP" value="/auth/forms/defaultForm.jsp"/>
          <param name="uidAttr" value="sub"/>
          <param name="uidIsFilter" value="false"/>
        </params>
      </authMech>
    </chain>
  </authChains>
  <resultGroups>
    <resultGroup name="Default Login Failure">
      <result>
        <type>redirect</type>
        <source>static</source>
        <value>/auth/forms/defaultFailedLogin.jsp</value>
      </result>
    </resultGroup>
    <resultGroup name="Logout">
      <result>
        <type>redirect</type>
        <source>static</source>
        <value>/auth/forms/logout.jsp</value>
      </result>
    </resultGroup>
    <resultGroup name="oauth2bearer">
      <type>header</type>
      <source>custom</source>
      <value>Authorization=com.tremolosecurity.proxy.results.InjectIdToken</value>
    </resultGroup>
  </resultGroups>
  <keyStorePath>/etc/openunison/unisonKeyStore.jks</keyStorePath>
  <keyStorePassword>#[unisonKeystorePassword]</keyStorePassword>
  <provisioning>
    <targets>
      <target name="jitdb" className="com.tremolosecurity.provisioning.core.providers.BasicDB">
        <params>
          <param name="driver" value="#[OU_JDBC_DRIVER]"/>
          <param name="url" value="#[OU_JDBC_URL]"/>
          <param name="user" value="#[OU_JDBC_USER]"/>
          <param name="password" value="#[OU_JDBC_PASSWORD]"/>
          <param name="maxCons" value="10"/>
          <param name="maxIdleCons" value="10"/>
          <param name="validationQuery" value="#[OU_JDBC_VALIDATION]" />
          <param name="userTable" value="localUsers"/>
          <param name="userPrimaryKey" value="userId"/>
          <param name="userName" value="sub"/>
          <param name="groupMode" value="ManyToMany"/>
          <param name="groupTable" value="localGroups"/>
          <param name="groupName" value="name"/>
          <param name="groupUserKey" value="userId"/>
          <param name="groupLinkTableName" value="userGroups"/>
          <param name="groupGroupKey" value="groupId"/>
          <param name="groupPrimaryKey" value="groupId"/>
          <param name="userSQL" value=""/>
          <param name="groupSQL" value=""/>
          <param name="customProvider" value=""/>
        </params>
        <targetAttribute name="sub" source="sub" sourceType="user"/>
        <targetAttribute name="mail" source="mail" sourceType="user"/>
      </target>
    </targets>
    <workflows>
      <workflow  name="jitdb" label="JIT" description="JIT" inList="false" orgid="687da09f-8ec1-48ac-b035-f2f182b9bd1e">
        <tasks>
          <mapping  strict="true">
            <map>
              <mapping targetAttributeName="TREMOLO_USER_ID" sourceType="user" targetAttributeSource="uid"/>
              <mapping targetAttributeName="sub" sourceType="user" targetAttributeSource="uid"/>
              <mapping targetAttributeName="mail" sourceType="user" targetAttributeSource="mail"/>
            </map>
            <onSuccess>
              <addGroup name="Users" />
              <customTask className="com.tremolosecurity.provisioning.customTasks.JITBasicDBCreateGroups">
                <param name="targetName" value="jitdb"/>
              </customTask>
              <provision sync="false" target="jitdb" setPassword="false" onlyPassedInAttributes="false" >
                <attributes>
                  <value>sub</value>
                  <value>mail</value>
                </attributes>
              </provision>
              <resync keepExternalAttrs="false" />
            </onSuccess>
          </mapping>
        </tasks>
      </workflow>
    </workflows>
    <approvalDB>
      <hibernateDialect>#[OU_HIBERNATE_DIALECT]</hibernateDialect>
      <driver>#[OU_JDBC_DRIVER]</driver>
      <url>#[OU_JDBC_URL]</url>
      <user>#[OU_JDBC_USER]</user>
      <password>#[OU_JDBC_PASSWORD]</password>
      <maxConns>10</maxConns>
      <maxIdleConns>10</maxIdleConns>
      <userIdAttribute>uid</userIdAttribute>
      <approverAttributes>
        <value>uid</value>
      </approverAttributes>
      <userAttributes>
        <value>uid</value>
      </userAttributes>
      <enabled>true</enabled>
      <smtpHost>#[SMTP_HOST]</smtpHost>
      <smtpPort>#[SMTP_PORT]</smtpPort>
      <smtpUser>#[SMTP_USER]</smtpUser>
      <smtpPassword>#[SMTP_PASSWORD]</smtpPassword>
      <smtpSubject>Awaiting Approvals</smtpSubject>
      <smtpFrom>#[SMTP_FROM]</smtpFrom>
      <smtpTLS>#[SMTP_TLS]</smtpTLS>
      <encryptionKey>session-unison</encryptionKey>
      <smtpUseSOCKSProxy>false</smtpUseSOCKSProxy>
      <smtpSOCKSProxyHost>
      </smtpSOCKSProxyHost>
      <smtpSOCKSProxyPort>0</smtpSOCKSProxyPort>
      <smtpLocalhost>localhost</smtpLocalhost>
      <validationQuery>#[OU_JDBC_VALIDATION]</validationQuery>
    </approvalDB>
    <org name="MyOrg" description="MyOrg Enterprise Applications" uuid="687da09f-8ec1-48ac-b035-f2f182b9bd1e">
    </org>
    <queueConfig isUseInternalQueue="true" maxProducers="5"  maxConsumers="5" taskQueueName="TremoloUnisonTaskQueue" smtpQueueName="TremoloUnisonSMTPQueue" encryptionKeyName="session-queues">
    </queueConfig>
    <portal>
    </portal>
    <scheduler useDB="false" threadCount="3" instanceLabel="testing" instanceIPMask="172"/>
    <listeners/>
    <reports>
    </reports>
  </provisioning>
</tremoloConfig>
